"use strict";!function(){function e(){var e=document.documentElement.clientHeight,t=a.offsetHeight,n=m.offsetHeight,o=e-t-n;r.style.height=o+"px"}var t=document.getElementsByClassName("chat-msg-send")[0],n=document.getElementsByClassName("chat-send-btn")[0],o=document.getElementsByClassName("chat-emoji-list")[0],s=(document.getElementsByClassName("info-tab")[0],document.getElementsByClassName("chat-msg-list")[0]),i=document.getElementsByClassName("chat-more-box")[0],a=document.getElementsByClassName("top-title")[0],r=document.getElementsByClassName("chat-ctx")[0],m=document.getElementsByClassName("chat-ctrl")[0],l=document.location.hostname,c="//"+l+":9998/",d=io(c),u={};u.data={isRoomInit:!1,messIsFirst:!0,messIsFoucs:!1,isInitInsertEmoji:!1,onlineUserCount:0,onlineUserList:[],onlineUserListImg:[],defaultUserImg:"/image/boysIcon.png",welcomeInfo:"系统: 欢迎来到 ",currentRoomName:null,user:{name:null,pass:null,desc:null,img:"/image/boysIcon.png",sex:"men"},robot:{api:document.location.origin+"/api/robot/openapi/api",key:"57a5b6849e2b4d47ae0badadf849c261",nick:"小美",img:"/image/boysIcon.png"}},u.room={init:function(){d.on("room id req",function(e){u.data.user.name=e.name,u.data.user.img=e.img,d.emit("room id res",u.data.currentRoomName),u.method.insertToList(s,"li",u.data.welcomeInfo+" "+u.data.currentRoomName),t.value="",t.focus(),i.style.visibility="hidden",t.onclick=function(){i.style.visibility="hidden",u.data.messIsFoucs=!0}}),d.on("user login req",function(e){u.method.insertToList(s,"li",e)}),d.on("user logout req",function(e){u.method.insertToList(s,"li",e.currentUser+" 离开了房间"),u.method.scrollToBottom()}),d.on("mess show res",function(e){for(var t=e.length,n=t-1;n>=0;n--){var o=u.method.renderBubbleMsg("left",e[n].user,u.method.parseTime(e[n].time),u.method.parseMsgVal(e[n].mess),e[n].img);u.method.insertToList(s,"li",o)}u.method.scrollToBottom()})},render:function(){d.on("current status",function(e){}),d.on("send message res",function(e){var t=u.method.parseTime(e.time),n=u.method.renderBubbleMsg("left",e.user,t,u.method.parseMsgVal(e.msg),e.img);u.method.insertToList(s,"li",n);var o=e.length;console.log("total message / "+o),u.method.scrollToBottom()})}},u.method={getCurrentRoomName:function(){var e=document.location.pathname,t="/"===e,n=null;return t||-1===e.indexOf("room")||(n=e.replace(/\/.*?\//,"")),null===n?n="Chat Room":decodeURIComponent(n)},initList:function(e){e.innerHTML=""},renderList:function(e,t,n){for(var o={chat:s,emoji:i},a=0;a<t.length;a++)this.insertToList(o[e],"li",t[a])},insertToList:function(e,t,n){var o=document.createElement(t);o.innerHTML=n,e.appendChild(o)},renderUserList:function(e,t){return'<img src="/image/boysIcon.png" class="user-img">\n        <span class="user-name">'+t+"</span>"},renderBubbleMsg:function(e,t,n,o,s){t=u.method.parseMsgVal(t),n=u.method.parseMsgVal(n),o=u.method.parseMsgVal(o);var i="";return i=""!==n?'\n          <ul class="bubble-info">\n            <li class="bubble-info-user">'+t+'</li>\n            <li class="bubble-info-time">'+n+"</li>\n          </ul>":"",void 0!==s&&null!==s||(s=u.data.defaultUserImg,s=u.method.parseMsgVal(s)),s=u.method.parseMsgVal(s),s=s.replace(/on[a-zA-z]+=/,""),'<div class="bubble bubble-'+e+'">\n        <div class="bubble-head">\n          <img src="/image/boysIcon.png" class="user-img">\n        </div>\n        <div class="bubble-ctx">\n          '+i+'\n          <div class="bubble-ctx-border">\n            <p class="bubble-ctx-show">'+o+"</p>\n          </div>\n        </div>\n      </div>"},parseMsgVal:function(e){var t=e.replace(/</g,"&lt;");return t=t.replace(/>/g,"&gt;"),t=t.replace(/"/g,'"'),t=t.replace(/'/g,"'")},getTime:function(e){return Date.parse(e)/1e3},parseTime:function(e){var t=new Date;return t.setTime(1e3*e),t.toLocaleString()},sendMessage:function(){if(""!==t.value){i.style.visibility="hidden";var e=u.method.getTime(new Date),n=null!==u.data.user.name?u.data.user.name:"神秘人",o=u.method.parseMsgVal(t.value),a=u.method.renderBubbleMsg("right",n,"",o,u.data.user.img);d.emit("send message req",e,u.data.currentRoomName,{time:e,msg:o}),u.method.insertToList(s,"li",a),t.value="",t.focus(),u.method.scrollToBottom(),"小美"===u.data.currentRoomName&&axios.get(u.data.robot.api,{params:{key:u.data.robot.key,info:o}}).then(function(t){var n=u.method.getTime(new Date),o=u.method.parseTime(n),i=u.method.renderBubbleMsg("left",u.data.robot.nick,o,t.data.text,u.data.robot.img);u.method.insertToList(s,"li",i),d.emit("send message req",e,u.data.currentRoomName,{user:u.data.robot.nick,time:n,msg:t.data.text,img:u.data.robot.img}),u.method.scrollToBottom()}).catch(function(e){return console.log(e)})}},getOnlineList:function(e,t){e.filter(function(e){if(e.name===t){var n=e.user.concat(),o=e.img.concat();u.data.onlineUserCount=e.user.length,u.data.onlineUserList=n,u.data.onlineUserListImg=o}})},getRandomImg:function(e){return"https://randomuser.me/api/portraits/"+e+"/"+parseInt(100*Math.random())+".jpg"},getRandomNick:function(e,t){return"https://uinames.com/api/?region="+e+"&gender="+t+"&amount=1"},getEmoji:function(e){var t=["😅","😂","🙂","🙃","😉","😘","😗","😜","😎","😏","😔","🙁","😶","😢","🤔","👏","🤝","👍","👎","✌","❤","🐶","🐱","🐰","🐭","🐷","🐸","🙈"],n=e||i;this.initList(n),"hidden"===n.style.visibility?i.style.visibility="visible":i.style.visibility="hidden",this.renderList("emoji",t),!1===u.data.isInitInsertEmoji&&this.initInsertEmoji()},initInsertEmoji:function(){i.addEventListener("click",function(e){"li"===e.target.tagName.toLowerCase()&&u.method.insertEmojiToText(e.target.innerText)},!1),u.data.isInitInsertEmoji=!0},insertEmojiToText:function(e){var n=t.value,o=t.selectionStart;u.data.messIsFirst&&!u.data.messIsFoucs&&(o=n.length),u.data.messIsFirst=!1,""===n?t.value=e:n.length===o?t.value=t.value+e:t.value=n.slice(0,o)+e+n.slice(o,n.length),t.focus()},scrollToBottom:function(){var e=document.getElementsByClassName("chat-ctx")[0];e.scrollTop=e.scrollHeight}},window.addEventListener("resize",function(){return e()},!1),document.body.onload=function(){e(),u.data.currentRoomName=u.method.getCurrentRoomName(),u.room.init(),u.room.render(),console.log(u.method.getRandomImg("men")),console.log(u.method.getRandomNick("china","male")),n.addEventListener("click",function(){return u.method.sendMessage()},!1),o.addEventListener("click",function(){return u.method.getEmoji()},!1)}}();